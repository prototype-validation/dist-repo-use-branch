# æœ‰ä¸ªå°ç¼ºé™·éœ€è¦è§£å†³ï¼Œfokrç«¯ï¼ˆä¸‹æ¸¸ï¼‰åˆ›å»ºåˆ†æ”¯æ—¶å¿…é¡»åŒåï¼Œå¦åˆ™åªæœ‰åˆ›å»ºæ—¶æ˜¯å¤åˆ¶çš„åˆ¶å®šåˆ†æ”¯ï¼Œåç»­ç›®æ ‡ä¼šè¢«å¼ºåˆ¶æ”¹ä¸ºä¸Šæ¸¸é»˜è®¤åˆ†æ”¯
# æŒ‰ç…§è§„èŒƒï¼Œå‘å¸ƒåˆ†æ”¯åº”å½“ä»…é™å•å‘æ¨é€
name: Validation

# è¿™é‡Œé€šè¿‡ä¸»åˆ†æ”¯çš„ push å’Œæ‰‹åŠ¨è§¦å‘å™¨è§¦å‘ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰å…¶ä»–è§¦å‘æ–¹å¼
on:
  workflow_dispatch:
  push:
    branches:
      - main

# ref https://docs.github.com/zh/actions/learn-github-actions/variables
env:
  cd_path: "test/ci" # (Githubï¼‰æŒç»­äº¤ä»˜è·¯å¾„, ä¸èƒ½ä»¥ / ç»“å°¾
  cd_branch: "main_-_cd_-_test" # ä¸èƒ½åŒ…å« / ç­‰å­—ç¬¦
  dist_path: "test/src" # åˆ†å‘è·¯å¾„, ä¸èƒ½ä»¥ / ç»“å°¾
  dist_branch: "main_-_dist_-_test" # ä¸èƒ½åŒ…å« / ç­‰å­—ç¬¦
  main_branch: "main" # å½“å‰ä»“åº“ï¼ˆä¸Šæ¸¸ï¼‰ä¸»åˆ†æ”¯

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ç¡®ä¿å¯ä»¥è·å–æ‰€æœ‰å†å²è®°å½•ï¼Œä»¥ä¾¿åˆå¹¶
          token: ${{ secrets.TOEKN_FOREVER_FULL_WRITE }} # ä½¿ç”¨å…·æœ‰å®Œå…¨å†™å…¥æƒé™çš„ TOKENï¼ˆå¿…é¡»åŒ…å« workflows ï¼‰

      - name: Set up Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'

      - name: Check if dist_branch exists in the remote
        id: dist_branch-exists
        run: |
          # grep -qE ä½¿ç”¨äº† -E å‚æ•°æ¥å¯ç”¨æ‰©å±•çš„æ­£åˆ™è¡¨è¾¾å¼, å¹¶ä¸”ä½¿ç”¨äº† $ ç¬¦å·æ¥ç¡®ä¿åŒ¹é…çš„å­—ç¬¦ä¸²ä»¥ main ç»“å°¾, è¾¾åˆ°ç²¾å‡†åŒ¹é…çš„ç›®çš„
          if git ls-remote --heads origin | grep -qE 'refs/heads/${{ env.dist_branch }}$'; then
            echo "branch_exists=true" >> $GITHUB_OUTPUT
            echo "Remote branch ${{ env.dist_branch }} exists."
          else
            echo "branch_exists=false" >> $GITHUB_OUTPUT
            echo "Remote branch ${{ env.dist_branch }} does not exist."
          fi
      - name: Check if cd_branch exists in the remote
        id: cd_branch-exists
        run: |
          # grep -qE ä½¿ç”¨äº† -E å‚æ•°æ¥å¯ç”¨æ‰©å±•çš„æ­£åˆ™è¡¨è¾¾å¼, å¹¶ä¸”ä½¿ç”¨äº† $ ç¬¦å·æ¥ç¡®ä¿åŒ¹é…çš„å­—ç¬¦ä¸²ä»¥ main ç»“å°¾, è¾¾åˆ°ç²¾å‡†åŒ¹é…çš„ç›®çš„
          if git ls-remote --heads origin | grep -qE 'refs/heads/${{ env.cd_branch }}$'; then
            echo "branch_exists=true" >> $GITHUB_OUTPUT
            echo "Remote branch ${{ env.cd_branch }} exists."
          else
            echo "branch_exists=false" >> $GITHUB_OUTPUT
            echo "Remote branch ${{ env.cd_branch }} does not exist."
          fi
      - name: Sync dist_path from main_branch to exists dist_branch
        if: steps.dist_branch-exists.outputs.branch_exists == 'true'
        run: |
          # ä¸»åˆ†æ”¯éœ€è¦é‡å¤ä½¿ç”¨, å› æ­¤åŸºäºä¸´æ—¶åˆ†æ”¯æ“ä½œ
          git checkout -b temp_${{ env.main_branch }} ${{ env.main_branch }}
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œå¦‚æœå®ƒä¸å­˜åœ¨çš„è¯
          mkdir -p $HOME/tmp
          # æ¸…ç©ºä¸´æ—¶æ–‡ä»¶å¤¹çš„å†…å®¹
          find $HOME/tmp/ -mindepth 1 -maxdepth 1 -exec rm -rf {} +
          ls -A $HOME/tmp/
          rsync -a --exclude '.git' ${{ env.dist_path }}/ $HOME/tmp/
          ls -A $HOME/tmp/
          git checkout ${{ env.dist_branch }}
          # æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶ï¼Œé™¤äº†.gitç›®å½•
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          rsync -a --exclude '.git' $HOME/tmp/ ./
          find . -path './.git' -prune -o -exec ls -lR {} +
          git add .
          git commit -m "ğŸª‚ Sync ${{ env.dist_path }} from ${{ env.main_branch }} to ${{ env.dist_branch }}" || echo "No changes to commit"
          # åˆ é™¤ä¸´æ—¶åˆ†æ”¯
          git branch -D temp_${{ env.main_branch }}
      - name: Sync cd_path from main_branch to exists cd_branch
        if: steps.cd_branch-exists.outputs.branch_exists == 'true'
        run: |
          # ä¸»åˆ†æ”¯éœ€è¦é‡å¤ä½¿ç”¨, å› æ­¤åŸºäºä¸´æ—¶åˆ†æ”¯æ“ä½œ
          git checkout -b temp_${{ env.main_branch }} ${{ env.main_branch }}
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œå¦‚æœå®ƒä¸å­˜åœ¨çš„è¯
          mkdir -p $HOME/tmp
          # æ¸…ç©ºä¸´æ—¶æ–‡ä»¶å¤¹çš„å†…å®¹
          find $HOME/tmp/ -mindepth 1 -maxdepth 1 -exec rm -rf {} +
          ls -A $HOME/tmp/
          rsync -a --exclude '.git' ${{ env.cd_path }}/ $HOME/tmp/
          ls -A $HOME/tmp/
          git checkout ${{ env.cd_branch }}
          # æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶ï¼Œé™¤äº†.gitç›®å½•
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          rsync -a --exclude '.git' $HOME/tmp/ ./
          find . -path './.git' -prune -o -exec ls -lR {} +
          git add .
          git commit -m "ğŸª‚ Sync ${{ env.cd_path }} from ${{ env.main_branch }} to ${{ env.cd_branch }}" || echo "No changes to commit"
          # åˆ é™¤ä¸´æ—¶åˆ†æ”¯
          git branch -D temp_${{ env.main_branch }}
      - name: Init dist_branch from dist_path at main_branch
        if: steps.dist_branch-exists.outputs.branch_exists == 'false'
        run: |
          # ä¸»åˆ†æ”¯éœ€è¦é‡å¤ä½¿ç”¨, å› æ­¤åŸºäºä¸´æ—¶åˆ†æ”¯æ“ä½œ
          git checkout -b temp_${{ env.main_branch }} ${{ env.main_branch }}
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œå¦‚æœå®ƒä¸å­˜åœ¨çš„è¯
          mkdir -p $HOME/tmp
          # æ¸…ç©ºä¸´æ—¶æ–‡ä»¶å¤¹çš„å†…å®¹
          find $HOME/tmp/ -mindepth 1 -maxdepth 1 -exec rm -rf {} +
          rsync -a --exclude '.git' ${{ env.dist_path }}/ $HOME/tmp/
          # æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶ï¼Œé™¤äº†.gitç›®å½•
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          # åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„åˆ†æ”¯, ä¸åŸºäºä»»ä½•ç°æœ‰çš„æäº¤
          git checkout --orphan ${{ env.dist_branch }}
          shopt -s dotglob nullglob
          # ç§»åŠ¨æ‰€æœ‰ééšè—æ–‡ä»¶å’Œç›®å½•
          files=($HOME/tmp/${{ env.dist_path }}/*)
          if [ ${#files[@]} -gt 0 ]; then
            mv $HOME/tmp/${{ env.dist_path }}/* .
          else
            echo "No non-hidden files or directories to move."
          fi
          # ç§»åŠ¨æ‰€æœ‰éšè—æ–‡ä»¶å’Œç›®å½•ï¼Œä½†æ’é™¤ . å’Œ ..
          hidden_files=($HOME/tmp/${{ env.dist_path }}/.[!.]*)
          if [ ${#hidden_files[@]} -gt 0 ]; then
            mv $HOME/tmp/${{ env.dist_path }}/.[!.]* .
          else
            echo "No hidden files or directories to move."
          fi
          shopt -u dotglob nullglob
          # shopt -s dotglob å‘½ä»¤å°†å¼€å¯shellé€‰é¡¹, ä½¿å¾—é€šé…ç¬¦ * åŒ…å«ä»¥ç‚¹å¼€å¤´çš„æ–‡ä»¶å’Œç›®å½•ã€‚
          # nullglob é€‰é¡¹ç¡®ä¿å½“æ²¡æœ‰åŒ¹é…çš„æ–‡ä»¶æ—¶, é€šé…ç¬¦ä¸å±•å¼€ä¸ºè‡ªèº«ã€‚
          # ä¹‹åï¼Œæˆ‘ä»¬é€šè¿‡ shopt -u dotglob nullglob å‘½ä»¤å…³é—­è¿™äº›é€‰é¡¹, ä»¥æ¢å¤é»˜è®¤è¡Œä¸ºã€‚
          git add .
          git commit -m "ğŸª‚ Initial ${{ env.dist_path }} from ${{ env.main_branch }} to ${{ env.dist_branch }}"
          # åˆ é™¤ä¸´æ—¶åˆ†æ”¯
          git branch -D temp_${{ env.main_branch }}
      - name: Init cd_branch from cd_path at main_branch
        if: steps.cd_branch-exists.outputs.branch_exists == 'false'
        run: |
          # ä¸»åˆ†æ”¯éœ€è¦é‡å¤ä½¿ç”¨, å› æ­¤åŸºäºä¸´æ—¶åˆ†æ”¯æ“ä½œ
          git checkout -b temp_${{ env.main_branch }} ${{ env.main_branch }}
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œå¦‚æœå®ƒä¸å­˜åœ¨çš„è¯
          mkdir -p $HOME/tmp
          # æ¸…ç©ºä¸´æ—¶æ–‡ä»¶å¤¹çš„å†…å®¹
          find $HOME/tmp/ -mindepth 1 -maxdepth 1 -exec rm -rf {} +
          rsync -a --exclude '.git' ${{ env.cd_path }}/ $HOME/tmp/
          # æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶ï¼Œé™¤äº†.gitç›®å½•
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          # åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„åˆ†æ”¯, ä¸åŸºäºä»»ä½•ç°æœ‰çš„æäº¤
          git checkout --orphan ${{ env.cd_branch }}
          shopt -s dotglob nullglob
          # ç§»åŠ¨æ‰€æœ‰ééšè—æ–‡ä»¶å’Œç›®å½•
          files=($HOME/tmp/${{ env.cd_path }}/*)
          if [ ${#files[@]} -gt 0 ]; then
            mv $HOME/tmp/${{ env.cd_path }}/* .
          else
            echo "No non-hidden files or directories to move."
          fi
          # ç§»åŠ¨æ‰€æœ‰éšè—æ–‡ä»¶å’Œç›®å½•ï¼Œä½†æ’é™¤ . å’Œ ..
          hidden_files=($HOME/tmp/${{ env.cd_path }}/.[!.]*)
          if [ ${#hidden_files[@]} -gt 0 ]; then
            mv $HOME/tmp/${{ env.cd_path }}/.[!.]* .
          else
            echo "No hidden files or directories to move."
          fi
          shopt -u dotglob nullglob
          # shopt -s dotglob å‘½ä»¤å°†å¼€å¯shellé€‰é¡¹, ä½¿å¾—é€šé…ç¬¦ * åŒ…å«ä»¥ç‚¹å¼€å¤´çš„æ–‡ä»¶å’Œç›®å½•ã€‚
          # nullglob é€‰é¡¹ç¡®ä¿å½“æ²¡æœ‰åŒ¹é…çš„æ–‡ä»¶æ—¶, é€šé…ç¬¦ä¸å±•å¼€ä¸ºè‡ªèº«ã€‚
          # ä¹‹åï¼Œæˆ‘ä»¬é€šè¿‡ shopt -u dotglob nullglob å‘½ä»¤å…³é—­è¿™äº›é€‰é¡¹, ä»¥æ¢å¤é»˜è®¤è¡Œä¸ºã€‚
          git add .
          git commit -m "ğŸª‚ Initial ${{ env.cd_path }} from ${{ env.main_branch }} to ${{ env.cd_branch }}"
          # åˆ é™¤ä¸´æ—¶åˆ†æ”¯
          git branch -D temp_${{ env.main_branch }}
      - run: |
          git checkout ${{ env.dist_branch }}
      - name: Push dist_branch
        id: push_dist_branch
        uses: ad-m/github-push-action@master
        with:
          branch: ${{ env.dist_branch }}
          force: true
          # force_with_lease: true # ä»…åœ¨è¿œç¨‹åˆ†æ”¯è‡ªä¸Šæ¬¡æ£€å‡ºä»¥æ¥æ²¡æœ‰å…¶ä»–æäº¤çš„æƒ…å†µä¸‹æˆåŠŸ
        env:
          github_token: ${{ secrets.TOEKN_FOREVER_FULL_WRITE }} # ä½¿ç”¨å…·æœ‰å®Œå…¨å†™å…¥æƒé™çš„ TOKENï¼ˆå¿…é¡»åŒ…å« workflows ï¼‰
      - run: |
          git checkout ${{ env.cd_branch }}
      - name: Push cd_branch
        id: push_cd_branch
        uses: ad-m/github-push-action@master
        with:
          branch: ${{ env.cd_branch }}
          force: true
          # force_with_lease: true # ä»…åœ¨è¿œç¨‹åˆ†æ”¯è‡ªä¸Šæ¬¡æ£€å‡ºä»¥æ¥æ²¡æœ‰å…¶ä»–æäº¤çš„æƒ…å†µä¸‹æˆåŠŸ
        env:
          github_token: ${{ secrets.TOEKN_FOREVER_FULL_WRITE }} # ä½¿ç”¨å…·æœ‰å®Œå…¨å†™å…¥æƒé™çš„ TOKENï¼ˆå¿…é¡»åŒ…å« workflows ï¼‰
