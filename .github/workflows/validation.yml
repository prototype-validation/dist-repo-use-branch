# æœ‰ä¸ªå°ç¼ºé™·éœ€è¦è§£å†³ï¼Œfokrç«¯ï¼ˆä¸‹æ¸¸ï¼‰åˆ›å»ºåˆ†æ”¯æ—¶å¿…é¡»åŒåï¼Œå¦åˆ™åªæœ‰åˆ›å»ºæ—¶æ˜¯å¤åˆ¶çš„åˆ¶å®šåˆ†æ”¯ï¼Œåç»­ç›®æ ‡ä¼šè¢«å¼ºåˆ¶æ”¹ä¸ºä¸Šæ¸¸é»˜è®¤åˆ†æ”¯
# æŒ‰ç…§è§„èŒƒï¼Œå‘å¸ƒåˆ†æ”¯åº”å½“ä»…é™å•å‘æ¨é€
name: Validation

# è¿™é‡Œé€šè¿‡ä¸»åˆ†æ”¯çš„ push å’Œæ‰‹åŠ¨è§¦å‘å™¨è§¦å‘ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰å…¶ä»–è§¦å‘æ–¹å¼
on:
  workflow_call:
    inputs:
      repository:  # ä¸Šæ¸¸ä»“åº“
        required: true
        type: string
      main_branch:  # ä¸Šæ¸¸ä¸»åˆ†æ”¯
        required: true
        type: string
      # cd_path:  # (Githubï¼‰æŒç»­äº¤ä»˜è·¯å¾„, ä¸èƒ½ä»¥ / ç»“å°¾
      #   required: true
      #   type: string
      # cd_branch: # ä¸èƒ½åŒ…å« / ç­‰å­—ç¬¦
      #   required: true
      #   type: string
      dist_path: # åˆ†å‘è·¯å¾„, ä¸èƒ½ä»¥ / ç»“å°¾
        required: true
        type: string
      dist_branch:  # ä¸èƒ½åŒ…å« / ç­‰å­—ç¬¦
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repository }}
          fetch-depth: 0  # ç¡®ä¿å¯ä»¥è·å–æ‰€æœ‰å†å²è®°å½•ï¼Œä»¥ä¾¿åˆå¹¶
          token: ${{ secrets.TOEKN_FOREVER_FULL_WRITE }} # ä½¿ç”¨å…·æœ‰å®Œå…¨å†™å…¥æƒé™çš„ TOKENï¼ˆå¿…é¡»åŒ…å« workflows ï¼‰

      - name: Set up Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'

      - name: Check if dist_branch exists in the remote
        id: dist_branch-exists
        run: |
          # grep -qE ä½¿ç”¨äº† -E å‚æ•°æ¥å¯ç”¨æ‰©å±•çš„æ­£åˆ™è¡¨è¾¾å¼, å¹¶ä¸”ä½¿ç”¨äº† $ ç¬¦å·æ¥ç¡®ä¿åŒ¹é…çš„å­—ç¬¦ä¸²ä»¥ main ç»“å°¾, è¾¾åˆ°ç²¾å‡†åŒ¹é…çš„ç›®çš„
          if git ls-remote --heads origin | grep -qE 'refs/heads/${{ inputs.dist_branch }}$'; then
            echo "branch_exists=true" >> $GITHUB_OUTPUT
            echo "Remote branch ${{ inputs.dist_branch }} exists."
          else
            echo "branch_exists=false" >> $GITHUB_OUTPUT
            echo "Remote branch ${{ inputs.dist_branch }} does not exist."
          fi
      # - name: Check if cd_branch exists in the remote
      #   id: cd_branch-exists
      #   run: |
      #     # grep -qE ä½¿ç”¨äº† -E å‚æ•°æ¥å¯ç”¨æ‰©å±•çš„æ­£åˆ™è¡¨è¾¾å¼, å¹¶ä¸”ä½¿ç”¨äº† $ ç¬¦å·æ¥ç¡®ä¿åŒ¹é…çš„å­—ç¬¦ä¸²ä»¥ main ç»“å°¾, è¾¾åˆ°ç²¾å‡†åŒ¹é…çš„ç›®çš„
      #     if git ls-remote --heads origin | grep -qE 'refs/heads/${{ inputs.cd_branch }}$'; then
      #       echo "branch_exists=true" >> $GITHUB_OUTPUT
      #       echo "Remote branch ${{ inputs.cd_branch }} exists."
      #     else
      #       echo "branch_exists=false" >> $GITHUB_OUTPUT
      #       echo "Remote branch ${{ inputs.cd_branch }} does not exist."
      #     fi
      - name: Sync dist_path from main_branch to exists dist_branch
        if: steps.dist_branch-exists.outputs.branch_exists == 'true'
        run: |
          # ä¸»åˆ†æ”¯éœ€è¦é‡å¤ä½¿ç”¨, å› æ­¤åŸºäºä¸´æ—¶åˆ†æ”¯æ“ä½œ
          git checkout -b temp_${{ inputs.main_branch }} ${{ inputs.main_branch }}
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œå¦‚æœå®ƒä¸å­˜åœ¨çš„è¯
          mkdir -p $HOME/tmp
          # æ¸…ç©ºä¸´æ—¶æ–‡ä»¶å¤¹çš„å†…å®¹
          find $HOME/tmp/ -mindepth 1 -maxdepth 1 -exec rm -rf {} +
          ls -A $HOME/tmp/
          rsync -a --exclude '.git' ${{ inputs.dist_path }}/ $HOME/tmp/
          ls -A $HOME/tmp/
          git checkout ${{ inputs.dist_branch }}
          # æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶ï¼Œé™¤äº†.gitç›®å½•
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          rsync -a --exclude '.git' $HOME/tmp/ ./
          find . -path './.git' -prune -o -exec ls -lR {} +
          git add .
          git commit -m "ğŸª‚ Sync ${{ inputs.dist_path }} from ${{ inputs.main_branch }} to ${{ inputs.dist_branch }}" || echo "No changes to commit"
          # åˆ é™¤ä¸´æ—¶åˆ†æ”¯
          git branch -D temp_${{ inputs.main_branch }}
      # - name: Sync cd_path from main_branch to exists cd_branch
      #   if: steps.cd_branch-exists.outputs.branch_exists == 'true'
      #   run: |
      #     # ä¸»åˆ†æ”¯éœ€è¦é‡å¤ä½¿ç”¨, å› æ­¤åŸºäºä¸´æ—¶åˆ†æ”¯æ“ä½œ
      #     git checkout -b temp_${{ inputs.main_branch }} ${{ inputs.main_branch }}
      #     # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œå¦‚æœå®ƒä¸å­˜åœ¨çš„è¯
      #     mkdir -p $HOME/tmp
      #     # æ¸…ç©ºä¸´æ—¶æ–‡ä»¶å¤¹çš„å†…å®¹
      #     find $HOME/tmp/ -mindepth 1 -maxdepth 1 -exec rm -rf {} +
      #     ls -A $HOME/tmp/
      #     rsync -a --exclude '.git' ${{ inputs.cd_path }}/ $HOME/tmp/
      #     ls -A $HOME/tmp/
      #     git checkout ${{ inputs.cd_branch }}
      #     # æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶ï¼Œé™¤äº†.gitç›®å½•
      #     find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
      #     rsync -a --exclude '.git' $HOME/tmp/ ./
      #     find . -path './.git' -prune -o -exec ls -lR {} +
      #     git add .
      #     git commit -m "ğŸª‚ Sync ${{ inputs.cd_path }} from ${{ inputs.main_branch }} to ${{ inputs.cd_branch }}" || echo "No changes to commit"
      #     # åˆ é™¤ä¸´æ—¶åˆ†æ”¯
      #     git branch -D temp_${{ inputs.main_branch }}
      - name: Init dist_branch from dist_path at main_branch
        if: steps.dist_branch-exists.outputs.branch_exists == 'false'
        run: |
          # ä¸»åˆ†æ”¯éœ€è¦é‡å¤ä½¿ç”¨, å› æ­¤åŸºäºä¸´æ—¶åˆ†æ”¯æ“ä½œ
          git checkout -b temp_${{ inputs.main_branch }} ${{ inputs.main_branch }}
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œå¦‚æœå®ƒä¸å­˜åœ¨çš„è¯
          mkdir -p $HOME/tmp
          # æ¸…ç©ºä¸´æ—¶æ–‡ä»¶å¤¹çš„å†…å®¹
          find $HOME/tmp/ -mindepth 1 -maxdepth 1 -exec rm -rf {} +
          rsync -a --exclude '.git' ${{ inputs.dist_path }}/ $HOME/tmp/
          # æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶ï¼Œé™¤äº†.gitç›®å½•
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          # åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„åˆ†æ”¯, ä¸åŸºäºä»»ä½•ç°æœ‰çš„æäº¤
          git checkout --orphan ${{ inputs.dist_branch }}
          rsync -a --exclude '.git' $HOME/tmp/ ./
          git add .
          git commit -m "ğŸª‚ Initial ${{ inputs.dist_path }} from ${{ inputs.main_branch }} to ${{ inputs.dist_branch }}"
          # åˆ é™¤ä¸´æ—¶åˆ†æ”¯
          git branch -D temp_${{ inputs.main_branch }}
      # - name: Init cd_branch from cd_path at main_branch
      #   if: steps.cd_branch-exists.outputs.branch_exists == 'false'
      #   run: |
      #     # ä¸»åˆ†æ”¯éœ€è¦é‡å¤ä½¿ç”¨, å› æ­¤åŸºäºä¸´æ—¶åˆ†æ”¯æ“ä½œ
      #     git checkout -b temp_${{ inputs.main_branch }} ${{ inputs.main_branch }}
      #     # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œå¦‚æœå®ƒä¸å­˜åœ¨çš„è¯
      #     mkdir -p $HOME/tmp
      #     # æ¸…ç©ºä¸´æ—¶æ–‡ä»¶å¤¹çš„å†…å®¹
      #     find $HOME/tmp/ -mindepth 1 -maxdepth 1 -exec rm -rf {} +
      #     rsync -a --exclude '.git' ${{ inputs.cd_path }}/ $HOME/tmp/
      #     # æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶ï¼Œé™¤äº†.gitç›®å½•
      #     find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
      #     # åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„åˆ†æ”¯, ä¸åŸºäºä»»ä½•ç°æœ‰çš„æäº¤
      #     git checkout --orphan ${{ inputs.cd_branch }}
      #     rsync -a --exclude '.git' $HOME/tmp/ ./
      #     git add .
      #     git commit -m "ğŸª‚ Initial ${{ inputs.cd_path }} from ${{ inputs.main_branch }} to ${{ inputs.cd_branch }}"
      #     # åˆ é™¤ä¸´æ—¶åˆ†æ”¯
      #     git branch -D temp_${{ inputs.main_branch }}
      - run: |
          git checkout ${{ inputs.dist_branch }}
      - name: Push dist_branch
        id: push_dist_branch
        uses: ad-m/github-push-action@master
        with:
          repository: ${{ inputs.repository }}
          branch: ${{ inputs.dist_branch }}
          force: true
          # force_with_lease: true # ä»…åœ¨è¿œç¨‹åˆ†æ”¯è‡ªä¸Šæ¬¡æ£€å‡ºä»¥æ¥æ²¡æœ‰å…¶ä»–æäº¤çš„æƒ…å†µä¸‹æˆåŠŸ
        env:
          github_token: ${{ secrets.TOEKN_FOREVER_FULL_WRITE }} # ä½¿ç”¨å…·æœ‰å®Œå…¨å†™å…¥æƒé™çš„ TOKENï¼ˆå¿…é¡»åŒ…å« workflows ï¼‰
      # - run: |
      #     git checkout ${{ inputs.cd_branch }}
      # - name: Push cd_branch
      #   id: push_cd_branch
      #   uses: ad-m/github-push-action@master
      #   with:
      #     repository: ${{ inputs.repository }}
      #     branch: ${{ inputs.cd_branch }}
      #     force: true
      #     # force_with_lease: true # ä»…åœ¨è¿œç¨‹åˆ†æ”¯è‡ªä¸Šæ¬¡æ£€å‡ºä»¥æ¥æ²¡æœ‰å…¶ä»–æäº¤çš„æƒ…å†µä¸‹æˆåŠŸ
      #   env:
      #     github_token: ${{ secrets.TOEKN_FOREVER_FULL_WRITE }} # ä½¿ç”¨å…·æœ‰å®Œå…¨å†™å…¥æƒé™çš„ TOKENï¼ˆå¿…é¡»åŒ…å« workflows ï¼‰
